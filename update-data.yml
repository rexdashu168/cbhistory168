name: è‡ªå‹•æ›´æ–°å¯è½‰å‚µè³‡æ–™

on:
  push:
    paths:
      - 'cb_issue.xlsx'  # åªè¦Excelè¢«ä¸Šå‚³å°±è‡ªå‹•åŸ·è¡Œ
  workflow_dispatch:  # ä¹Ÿå¯æ‰‹å‹•åŸ·è¡Œ

permissions:
  contents: write  # å…è¨±å¯«å…¥æ¬Šé™

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ä¸‹è¼‰ç¨‹å¼ç¢¼
      uses: actions/checkout@v3
      
    - name: ğŸ è¨­å®šPythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ å®‰è£å¿…è¦å¥—ä»¶
      run: |
        pip install pandas openpyxl
        
    - name: ğŸ”„ è½‰æ›Excelç‚ºJSON
      run: |
        python3 << 'PYTHON_SCRIPT'
        import pandas as pd
        import json
        from datetime import datetime
        
        print("=" * 60)
        print("é–‹å§‹è½‰æ›è³‡æ–™...")
        print("=" * 60)
        
        # è®€å–Excel
        df = pd.read_excel('cb_issue.xlsx', sheet_name='allcbissue')
        print(f"âœ“ è®€å– {len(df)} ç­†è³‡æ–™")
        
        # è½‰æ›æ ¼å¼
        data = []
        for _, row in df.iterrows():
            list_date = str(row.get('æ›ç‰Œæ—¥æœŸ', ''))
            if 'Timestamp' in list_date or len(list_date) > 10:
                list_date = list_date[:10]
            
            data.append({
                'cbCode': str(row.get('CBä»£ç¢¼', '')).replace('.0', ''),
                'cbName': str(row.get('CBåç¨±', '')),
                'stockCode': str(row.get('è‚¡ç¥¨ä»£ç¢¼', '')),
                'size': float(row.get('ç™¼è¡Œè¦æ¨¡', 0)) if pd.notna(row.get('ç™¼è¡Œè¦æ¨¡')) else 0,
                'guarantee': str(row.get('æœ‰ç„¡æ“”ä¿', '')),
                'year': float(row.get('ç™¼è¡Œå¹´æœŸ', 0)) if pd.notna(row.get('ç™¼è¡Œå¹´æœŸ')) else 0,
                'convPrice': float(row.get('è½‰æ›åƒ¹æ ¼', 0)) if pd.notna(row.get('è½‰æ›åƒ¹æ ¼')) else 0,
                'listDate': list_date,
                'maturity': str(row.get('ä¸‹å¸‚æ—¥æœŸ', '')),
                'high': float(row.get('æ›ç‰Œæœ€é«˜', 0)) if pd.notna(row.get('æ›ç‰Œæœ€é«˜')) else 0,
                'low': float(row.get('æ›ç‰Œæœ€ä½', 0)) if pd.notna(row.get('æ›ç‰Œæœ€ä½')) else 0,
                'putDate1': str(row.get('è³£å›æ—¥æœŸ1', '-')),
                'putPrice1': float(row.get('è³£å›åƒ¹æ ¼1', 0)) if pd.notna(row.get('è³£å›åƒ¹æ ¼1')) else 0,
                'rate1': float(row.get('è³£å›æ®–åˆ©ç‡1', 0)) if pd.notna(row.get('è³£å›æ®–åˆ©ç‡1')) else 0,
                'putDate2': str(row.get('è³£å›æ—¥æœŸ2', '-')),
                'putPrice2': float(row.get('è³£å›åƒ¹æ ¼2', 0)) if pd.notna(row.get('è³£å›åƒ¹æ ¼2')) else 0,
                'rate2': float(row.get('è³£å›æ®–åˆ©ç‡2', 0)) if pd.notna(row.get('è³£å›æ®–åˆ©ç‡2')) else 0,
                'underwriter': str(row.get('æ‰¿éŠ·åˆ¸å•†', '')),
                'industry': str(row.get('ç”¢æ¥­åˆ†é¡', '')),
                'method': str(row.get('æ‰¿éŠ·æ–¹å¼', '')),
                'capital': str(row.get('è‚¡æœ¬è¦æ¨¡', ''))
            })
        
        # å„²å­˜JSON
        with open('cb_data.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False)
        
        print("=" * 60)
        print(f"âœ… è½‰æ›å®Œæˆï¼")
        print(f"è³‡æ–™ç­†æ•¸: {len(data)}")
        print(f"æ›´æ–°æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 60)
        PYTHON_SCRIPT
        
    - name: ğŸ“¤ è‡ªå‹•æäº¤æ›´æ–°
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet cb_data.json; then
          echo "ğŸ“‹ è³‡æ–™ç„¡è®Šæ›´ï¼Œè·³éæäº¤"
        else
          git add cb_data.json
          git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°è³‡æ–™ $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€"
        fi
