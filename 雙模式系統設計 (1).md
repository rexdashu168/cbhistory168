# AI智能競拍系統 - 雙模式設計

## 🎯 核心概念

### **為什麼需要兩種模式？**

**理論價低的標的，溢價率會失真！**

```
案例：理論價 85元

❌ 溢價率模式：85 × (1 + 8%) = 91.8元
✅ 實際最低得標：105.78元

→ 差距 14元！溢價率模式完全失效
```

---

## 📊 智能判斷邏輯

### **系統自動選擇模式：**

```javascript
IF (理論價格 < 95元) {
    // 查詢該區間的歷史平均最低得標價
    歷史參考價 = statistics['維度統計']['理論價'][區間]['平均最低得標']
    
    IF (歷史參考價 - 理論價格 > 5元) {
        使用「絕對價格模式」
        // 因為價格偏離太大，溢價率失真
    } ELSE {
        使用「溢價率模式」
    }
    
} ELSE {
    使用「溢價率模式」
    // 理論價 ≥ 95元，溢價率模式可靠
}
```

---

## 🔧 模式1：溢價率模式

### **適用條件：**
- 理論價格 ≥ 95元
- 或價格偏離 ≤ 5元

### **計算方式：**

```javascript
// 步驟1：AI計算綜合溢價率
綜合溢價率 = 加權計算各維度溢價率

// 步驟2：三種策略（基於歷史最低-平均差距 1.86%）
保守溢價率 = 綜合溢價率 - 0.93%
平衡溢價率 = 綜合溢價率
積極溢價率 = 綜合溢價率 + 0.93%

// 步驟3：計算投標價
保守價 = 理論價格 × (1 + 保守溢價率/100)
平衡價 = 理論價格 × (1 + 平衡溢價率/100)
積極價 = 理論價格 × (1 + 積極溢價率/100)
```

### **範例：**
```
理論價格：100元
AI溢價率：8%

保守：100 × (1 + 7.07%) = 107.07元
平衡：100 × (1 + 8.00%) = 108.00元
積極：100 × (1 + 8.93%) = 108.93元

價差：1.86元 ✅
```

---

## 🔧 模式2：絕對價格模式

### **適用條件：**
- 理論價格 < 95元
- 且價格偏離 > 5元

### **計算方式：**

```javascript
// 步驟1：找出相似案例的歷史價格
相似案例條件 = {
    理論價區間: 相同,
    產業: 相同（優先）,
    擔保: 相同（優先）,
    規模: 接近
}

// 步驟2：取得歷史參考價
歷史最低得標 = 相似案例的平均最低得標價
歷史平均得標 = 相似案例的平均得標價

// 步驟3：三種策略（基於歷史價差 1.84元）
保守價 = 歷史最低得標 - 0.92元
平衡價 = 歷史最低得標
積極價 = 歷史最低得標 + 0.92元
```

### **範例：**
```
理論價格：85元
歷史相似案例（85-90元區間）：
- 平均最低得標：105.78元
- 平均得標：107.62元

保守：105.78 - 0.92 = 104.86元
平衡：105.78元
積極：105.78 + 0.92 = 106.70元

價差：1.84元 ✅

⚠️ 如果用溢價率8%：85 × 1.08 = 91.8元（根本不可能得標！）
```

---

## 📊 各區間統計數據（內建）

| 理論價區間 | 樣本數 | 平均理論價 | 平均最低得標 | 價格偏離 | 建議模式 |
|-----------|--------|-----------|------------|---------|---------|
| <85元 | 12 | 81.95 | 104.03 | +22.08 | **絕對價格** |
| 85-90元 | 20 | 88.76 | 105.78 | +17.03 | **絕對價格** |
| 90-95元 | 51 | 93.45 | 105.53 | +12.09 | **絕對價格** |
| 95-98元 | 52 | 96.59 | 105.71 | +9.12 | **溢價率** |
| 98-100元 | 46 | 99.03 | 104.44 | +5.41 | **溢價率** |
| 100-102元 | 36 | 101.18 | 108.37 | +7.19 | **溢價率** |
| 102-105元 | 23 | 103.31 | 108.69 | +5.38 | **溢價率** |
| 105-110元 | 28 | 106.98 | 111.84 | +4.87 | **溢價率** |
| >110元 | 18 | 118.76 | 112.55 | -6.21 | **溢價率** |

---

## 🎨 前端顯示設計

### **當觸發「絕對價格模式」時：**

```
⚠️ 智能模式切換

系統偵測到：
- 理論價格：85.00元
- 該區間歷史平均最低得標：105.78元
- 價格偏離：+20.78元

由於價格偏離過大，溢價率模式會失真。
系統已自動切換為「絕對價格模式」。

投標價格將基於：
✓ 歷史相似案例的實際得標價
✓ 而非理論價格的溢價率計算
```

### **兩種模式對比顯示：**

```
┌─────────────────────────────────────┐
│ 📊 模式比較                          │
├─────────────────────────────────────┤
│ 溢價率模式（不適用）                  │
│   理論價 85元 × 1.08 = 91.8元        │
│   ❌ 歷史數據顯示無法得標             │
├─────────────────────────────────────┤
│ 絕對價格模式（系統採用）              │
│   保守：104.86元                     │
│   平衡：105.78元 ✓                   │
│   積極：106.70元                     │
│   ✅ 基於20檔相似案例統計             │
└─────────────────────────────────────┘
```

---

## 🔍 相似案例搜尋邏輯

### **搜尋條件優先順序：**

```javascript
1. 理論價區間（必須相同）
2. 產業分類（權重 40%）
3. 擔保情況（權重 30%）
4. 發行規模（權重 20%）
5. 信用評等（權重 10%）

相似度計算：
similarity_score = 
    (產業相同 ? 0.4 : 0) +
    (擔保相同 ? 0.3 : 0) +
    (規模相近 ? 0.2 × (1 - abs(規模差/規模)) : 0) +
    (信評相近 ? 0.1 × (1 - abs(信評差/9)) : 0)

取相似度 > 0.5 的案例
至少3檔，最多10檔
```

---

## 💻 程式碼實作

### **JavaScript 核心函數：**

```javascript
function calculateBidPrice(data, statistics) {
    // 計算理論價格
    const theoreticalPrice = (data.stockPrice / data.conversionPrice) * 100;
    
    // 取得該區間統計
    const theoRange = getTheoRange(theoreticalPrice);
    const rangeStats = statistics['維度統計']['理論價'][theoRange];
    
    // 判斷模式
    const priceOffset = rangeStats['平均最低得標'] - theoreticalPrice;
    const useAbsoluteMode = (theoreticalPrice < 95 && priceOffset > 5);
    
    let bidPrices;
    
    if (useAbsoluteMode) {
        // 絕對價格模式
        const referencePrice = rangeStats['平均最低得標'];
        bidPrices = {
            mode: 'absolute',
            conservative: referencePrice - 0.92,
            balanced: referencePrice,
            aggressive: referencePrice + 0.92,
            warning: true,
            priceOffset: priceOffset
        };
    } else {
        // 溢價率模式
        const comprehensivePremium = calculatePremium(data, statistics);
        bidPrices = {
            mode: 'premium',
            conservative: theoreticalPrice * (1 + (comprehensivePremium - 0.93) / 100),
            balanced: theoreticalPrice * (1 + comprehensivePremium / 100),
            aggressive: theoreticalPrice * (1 + (comprehensivePremium + 0.93) / 100),
            warning: false,
            comprehensivePremium: comprehensivePremium
        };
    }
    
    return bidPrices;
}
```

---

## 📋 統計數據更新

### **需要新增到 cb_statistics.json：**

```json
"維度統計": {
    "理論價": {
        "<85元": {
            "樣本數": 12,
            "平均最低得標": 104.03,
            "平均最低溢價": 26.99,
            "價格偏離": 22.08
        },
        "85-90元": {
            "樣本數": 20,
            "平均最低得標": 105.78,
            "平均最低溢價": 19.22,
            "價格偏離": 17.03
        },
        // ... 其他區間
    }
}
```

---

## ✅ 優勢總結

### **雙模式系統的好處：**

1. **智能適應**
   - 自動判斷使用哪種模式
   - 避免溢價率失真

2. **數據驅動**
   - 兩種模式都基於286檔統計
   - 不是主觀決定

3. **風險控制**
   - 防止「理論價低但實際高價」的陷阱
   - 提供合理的投標價格區間

4. **透明可解釋**
   - 清楚告訴使用者為何切換模式
   - 顯示歷史相似案例

---

## 🎯 實施計畫

### **Phase 1：更新統計數據**
- [x] 新增「價格偏離」欄位
- [ ] 更新 cb_statistics.json

### **Phase 2：實作雙模式邏輯**
- [ ] 模式判斷函數
- [ ] 絕對價格模式計算
- [ ] 溢價率模式調整（±0.93%）

### **Phase 3：前端展示**
- [ ] 模式切換提示
- [ ] 兩種模式對比
- [ ] 相似案例列表

### **Phase 4：測試驗證**
- [ ] 理論價 <85元 案例
- [ ] 理論價 85-95元 案例
- [ ] 理論價 >95元 案例

---

**Rex大叔，這個設計符合您的想法嗎？** 🎯
